apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include crunchy-postgres-#{ENV}# . }}-init-sql
  labels:
    app.kubernetes.io/name: {{ include crunchy-postgres-#{ENV}# . }}
    helm.sh/chart: {{ include crunchy-postgres-#{ENV}# . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
data:
  init.sql: |
    \set ON_ERROR_STOP on
    \c coms

    -- Allow access to public schema for coms user managed by crunchy 
    GRANT USAGE ON SCHEMA public TO coms;
    GRANT CREATE ON SCHEMA public TO coms;

    -- sensible defaults for future objects
    ALTER DEFAULT PRIVILEGES IN SCHEMA public
      GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO coms;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public
      GRANT USAGE, SELECT ON SEQUENCES TO coms;
